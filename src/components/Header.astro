---
interface Props {
  lang: 'en' | 'es';
}

const { lang } = Astro.props;

import enLocales from '../../public/locales/en.json';
import esLocales from '../../public/locales/es.json';
import { getService, type ServiceData } from '../data/services-multilingual';
import MobileMenu from './MobileMenu.jsx';

const t = lang === 'es' ? esLocales : enLocales;
const serviceIds = ['desarrollo-a-medida', 'consultoria-transformacion', 'innovacion-subvencionada'];
const services = serviceIds.map(id => getService(id, lang)).filter(Boolean) as ServiceData[];

const mobileItems = [
  { label: lang === 'es' ? 'Inicio' : 'Home', link: `/${lang}/#hero` },
  {
    label: t['nav.services'],
    link: `/${lang}/#services`,
    children: services.map(s => ({ label: s.title, link: `/${lang}/servicios/${s.id}` })),
  },
  { label: t['nav.aboutUs'], link: `/${lang}/#about-us` },
  { label: t['nav.contact'], link: `/${lang}/#contact` },
];
const mobileSocials = [
  { label: 'LinkedIn', link: 'https://www.linkedin.com/company/osix-tech' },
];
---

<header id="main-header" class="fixed top-0 left-0 w-full bg-white transition-all duration-300 shadow-lg z-50 md:px-12 md:py-6 px-6 py-3">

  <nav class="flex flex-row items-center justify-between font-medium text-white" id="main-nav">
      <!-- Logo and navigation container -->

      <a href={`/${lang}`} class="logo-link flex items-center font-bold text-2xl lg:text-3xl">
        <img src="/full_logo.png" alt="OSIX Tech logo" class="w-[148px] md:w-[200px]">
      </a>

      <div class="flex items-center gap-8">
        <!-- Desktop navigation -->
        <ul class="hidden md:flex items-center text-black text-[18px] font-semibold lg:gap-8 md:gap-6 relative tracking-wider">
          <li><a href={`/${lang}/#hero`} class="nav-item transition-colors duration-200">{lang === 'es' ? 'Inicio' : 'Home'}</a></li>
          <li class="nav-dropdown relative" data-dropdown="services">
            <button class="nav-item text-[18px] font-semibold transition-colors duration-200 cursor-pointer flex items-center gap-1" data-section="services">
              {t['nav.services']}
              <svg class="w-3 h-3 mt-0.5 nav-dropdown-arrow transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </li>
          <li><a href={`/${lang}/#about-us`} class="nav-item transition-colors duration-200">{t['nav.aboutUs']}</a></li>
       </ul>
        
        <!-- Navigation indicator line -->
        <div id="nav-indicator" class="absolute bottom-0 h-[2px] bg-black opacity-0 transition-all duration-300 ease-out"></div>
      </div>
      
      <!-- Right side: Language selector -->
      <div class="flex items-center gap-4 transition-opacity duration-300">
        <div class="hidden md:block">
            <a href={`/${lang}/#contact`} class="contact-btn btn-primary btn-arrow">
              {t['nav.contact']}
              <svg class="btn-arrow-icon" width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 8h10M9 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </a>
        </div>
        
        <!-- Mobile menu button -->
        <button id="mobile-toggle" class="md:hidden flex items-center justify-center w-10 h-10 relative" aria-label="Toggle menu">
          <div class="burger-icon">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </button>
      </div>
    </nav>
  
  <!-- Shared dropdown panel -->
  <div class="nav-expansion absolute left-0 right-0 top-full bg-white shadow-lg overflow-hidden" id="nav-dropdown-panel">
    <div class="px-6 md:px-12 py-4 relative">
      <!-- Services card group -->
      <div class="card-group" data-group="services">
        <div class="flex flex-row items-stretch gap-3">
          {services.map((service) => (
            <a href={`/${lang}/servicios/${service.id}`} class="nav-card group flex-1 flex flex-col justify-between gap-2 p-5 rounded-0 no-underline transition-opacity duration-300 hover:opacity-80" style="background-color: #0a0a0a; color: #fff;">
              <span class="nav-card-label font-semibold text-[18px] tracking-tight">{service.title}</span>
              <span class="nav-card-tagline text-[14px] opacity-70 leading-snug">{service.tagline}</span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>

  <MobileMenu lang={lang} items={mobileItems} socialItems={mobileSocials} client:load />
</header>

<script>
// Type definitions

// Global state
interface HeaderState {
  header: HTMLElement | null;
  heroSection: HTMLElement | null;
  navIndicator: HTMLElement | null;
  activeNavItem: HTMLElement | null;
  disableIndicatorUpdate: boolean;
  isMenuOpen: boolean;
  dropdownTriggers: Map<string, HTMLElement>;
  dropdownPanel: HTMLElement | null;
  activeDropdown: string | null;
  scrollListener: (() => void) | null;
  resizeListener: (() => void) | null;
  mobileToggleListener: (() => void) | null;
  mobileClosedListener: ((e: Event) => void) | null;
  mobileOpenedListener: ((e: Event) => void) | null;
}

const state: HeaderState = {
  header: null,
  heroSection: null,
  navIndicator: null,
  activeNavItem: null,
  disableIndicatorUpdate: false,
  isMenuOpen: false,
  dropdownTriggers: new Map(),
  dropdownPanel: null,
  activeDropdown: null,
  scrollListener: null,
  resizeListener: null,
  mobileToggleListener: null,
  mobileClosedListener: null,
  mobileOpenedListener: null
};

// Clean up existing listeners
function cleanupListeners() {
  if (state.scrollListener) {
    window.removeEventListener('scroll', state.scrollListener);
    state.scrollListener = null;
  }
  if (state.resizeListener) {
    window.removeEventListener('resize', state.resizeListener);
    state.resizeListener = null;
  }
  if (state.mobileToggleListener) {
    document.getElementById('mobile-toggle')?.removeEventListener('click', state.mobileToggleListener);
    state.mobileToggleListener = null;
  }
  if (state.mobileClosedListener) {
    window.removeEventListener('mobile-menu-closed', state.mobileClosedListener);
    state.mobileClosedListener = null;
  }
  if (state.mobileOpenedListener) {
    window.removeEventListener('mobile-menu-opened', state.mobileOpenedListener);
    state.mobileOpenedListener = null;
  }
}

// Initialize header
function initializeHeader() {
  cleanupListeners();
  
  // Get DOM elements
  state.header = document.getElementById('main-header');
  state.heroSection = document.querySelector('section#hero') as HTMLElement | null;
  state.navIndicator = document.getElementById('nav-indicator');
  // Setup dropdown triggers and shared panel
  state.dropdownTriggers = new Map();
  state.dropdownPanel = document.getElementById('nav-dropdown-panel');
  state.activeDropdown = null;
  document.querySelectorAll('.nav-dropdown[data-dropdown]').forEach(trigger => {
    const key = trigger.getAttribute('data-dropdown')!;
    state.dropdownTriggers.set(key, trigger as HTMLElement);
  });

  // Reset state
  state.activeNavItem = null;
  state.disableIndicatorUpdate = false;

  // Show header on subpages (not on main page with hero)
  if (!state.heroSection && state.header) {
    state.header.classList.add('visible');
    state.header.style.transform = 'translateY(0)';
    state.header.style.opacity = '1';

    // Check if this is a product/service page and set the indicator
    const pathname = window.location.pathname;
    if (pathname.includes('/servicios/')) {
      const servicesBtn = document.querySelector('[data-dropdown="services"] .nav-item') as HTMLElement | null;
      if (servicesBtn) {
        servicesBtn.classList.add('nav-active');
        state.activeNavItem = servicesBtn;
        setTimeout(() => moveIndicatorTo(servicesBtn), 100);
      }
    }
  } else if (state.header) {
    // This is the main page with hero section
    // Ensure header is hidden initially
    state.header.classList.remove('visible');
    state.header.style.transform = 'translateY(-100%)';
    state.header.style.opacity = '0';
  }
  
  // Reset nav indicator
  if (state.navIndicator) {
    state.navIndicator.style.opacity = '0';
  }
  
  // Set up all functionality
  setupToggleHeaderVisibility();
  setupNavigation();
  setupMobileMenu();
  setupDropdowns();
  setupScrollHandlers();
  
  // Initial check
  if (state.heroSection) {
    toggleHeaderVisibility();
  }
  setActiveNavItem();
}

// Toggle header visibility based on scroll
function toggleHeaderVisibility() {
  if (!state.header) return;
  
  // On pages without hero section, always show header
  if (!state.heroSection) {
    state.header.classList.add('visible');
    state.header.style.transform = 'translateY(0)';
    state.header.style.opacity = '1';
    return;
  }

  // On pages with hero section, show/hide based on scroll
  const scrollPosition = window.scrollY;
  const heroHeight = state.heroSection.offsetHeight;
  // Show header only after completely scrolling past hero section
  if (scrollPosition >= heroHeight - 100) {
    state.header.classList.add('visible');
    state.header.style.transform = '';
    state.header.style.opacity = '';
  } else {
    state.header.classList.remove('visible');
    state.header.style.transform = '';
    state.header.style.opacity = '';
  }
}

// Setup toggle header visibility
function setupToggleHeaderVisibility() {
  if (!state.heroSection) return;
  
  state.scrollListener = () => {
    toggleHeaderVisibility();
    setActiveNavItem();
  };
  
  window.addEventListener('scroll', state.scrollListener);
}

// Move the underline indicator under the given nav link, accounting for padding and overall nav offset
function moveIndicatorTo(linkEl: HTMLElement | null) {
  if (!state.navIndicator || !linkEl) return;
  const nav = document.getElementById('main-nav');
  if (!nav) return;

  const navRect = nav.getBoundingClientRect();
  const linkRect = linkEl.getBoundingClientRect();
  const computed = window.getComputedStyle(linkEl);
  const padLeft = parseFloat(computed.paddingLeft) || 0;
  const padRight = parseFloat(computed.paddingRight) || 0;

  const width = linkRect.width - padLeft - padRight;
  const left = linkRect.left - navRect.left + padLeft;

  state.navIndicator.style.width = `${width}px`;
  state.navIndicator.style.left = `${left}px`;
  state.navIndicator.style.opacity = '1';
}

function updateIndicatorBySection(sectionId: string) {
  // Don't show header or indicator on home section
  if (sectionId === 'hero' && state.heroSection) {
    state.header?.classList.remove('visible');
    if (state.navIndicator) {
      state.navIndicator.style.opacity = '0';
    }
    return;
  }
  
  // Special handling for contact section - show header but hide indicator
  if (sectionId === 'contact') {
    state.header?.classList.add('visible');
    if (state.navIndicator) {
      state.navIndicator.style.opacity = '0';
    }
    // Remove active class from all nav items
    const allNavLinks = document.querySelectorAll('nav .nav-item');
    allNavLinks.forEach(link => link.classList.remove('nav-active'));
    state.activeNavItem = null;
    return;
  }
  
  let targetNavItem = document.querySelector(`nav .nav-item[href$="#${sectionId}"]`) as HTMLElement | null;
  // Fallback for dropdown buttons (Services without href)
  if (!targetNavItem && sectionId === 'services') {
    targetNavItem = document.querySelector('[data-dropdown="services"] .nav-item') as HTMLElement | null;
  }
  if (targetNavItem) {
    // Update .nav-active on scroll-based section change
    const allNavLinks = document.querySelectorAll('nav .nav-item');
    allNavLinks.forEach(link => link.classList.remove('nav-active'));
    targetNavItem.classList.add('nav-active');
    state.activeNavItem = targetNavItem;
    moveIndicatorTo(targetNavItem);
    state.header?.classList.add('visible');
  } else if (state.activeNavItem) {
    moveIndicatorTo(state.activeNavItem);
  }
}

// Set active nav item based on scroll
function setActiveNavItem() {
  if (state.disableIndicatorUpdate || !state.header) return;

  const sections = document.querySelectorAll('section[id]');
  // Add 1px to avoid falling through exactly at section bottom
  let scrollPosition = window.scrollY + state.header.offsetHeight + 1;
  let foundActiveSection = false;
  
  const firstSection = document.querySelector('section#hero') || document.querySelector('section:first-of-type');
  if (firstSection && scrollPosition < (firstSection as HTMLElement).offsetHeight) {
    // Hide header on hero section
    state.header.classList.remove('visible');
    updateIndicatorBySection('hero');
    return;
  }
  
  // Check if we're in between sections but past the hero
  let pastHero = false;
  if (state.heroSection) {
    const heroHeight = state.heroSection.offsetHeight;
    pastHero = scrollPosition >= heroHeight - 100;
  }
  
  sections.forEach(section => {
    const sectionTop = (section as HTMLElement).offsetTop - state.header!.offsetHeight;
    const sectionHeight = (section as HTMLElement).offsetHeight;
    const sectionId = section.getAttribute('id');
    
    if (sectionId && 
        scrollPosition >= sectionTop && 
        scrollPosition < sectionTop + sectionHeight) {
      updateIndicatorBySection(sectionId);
      foundActiveSection = true;
    }
  });
  
  if (!foundActiveSection && state.heroSection) {
    // If we're past hero but between sections, keep header visible
    if (pastHero) {
      state.header.classList.add('visible');
      // Keep the last active nav item if we're between sections
      if (state.activeNavItem) {
        moveIndicatorTo(state.activeNavItem);
      } else if (state.navIndicator) {
        state.navIndicator.style.opacity = '0';
      }
    } else {
      // Only hide when we're back in the hero section
      state.header.classList.remove('visible');
      if (state.navIndicator) {
        state.navIndicator.style.opacity = '0';
      }
    }
  }
}

// Setup navigation
function setupNavigation() {
  const navItems = document.querySelectorAll('.nav-item');
  const allNavLinks = document.querySelectorAll('nav .nav-item');
  const logoLink = document.querySelector('.logo-link');
  
  // Helper function to get the correct nav item to return to
  const getReturnNavItem = () => {
    if (window.location.pathname.includes('/servicios/')) {
      return document.querySelector('[data-dropdown="services"] .nav-item') as HTMLElement | null;
    }
    return state.activeNavItem;
  };

  // Nav item hover
  navItems.forEach(item => {
    const navLink = item as HTMLElement;
    const isProjectsItem = navLink.closest('.nav-dropdown') !== null;

    if (isProjectsItem) {
      const dropdownParent = navLink.closest('.nav-dropdown') as HTMLElement;
      dropdownParent.addEventListener('mouseenter', () => {
        if (state.disableIndicatorUpdate) return;
        moveIndicatorTo(navLink);
      });

      dropdownParent.addEventListener('mouseleave', () => {
        if (state.disableIndicatorUpdate) return;
        const returnItem = getReturnNavItem();
        if (returnItem) {
          moveIndicatorTo(returnItem);
        } else if (state.navIndicator) {
          state.navIndicator.style.opacity = '0';
        }
      });
    } else {
      navLink.addEventListener('mouseenter', () => {
        if (state.disableIndicatorUpdate) return;
        moveIndicatorTo(navLink);
      });

      navLink.addEventListener('mouseleave', () => {
        if (state.disableIndicatorUpdate) return;
        const returnItem = getReturnNavItem();
        if (returnItem) {
          moveIndicatorTo(returnItem);
        } else if (state.navIndicator) {
          state.navIndicator.style.opacity = '0';
        }
      });
    }
  });

  // Nav link clicks
  allNavLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      const href = link.getAttribute('href');
      
      // Don't prevent default for navigation links that go to different pages
      if (!href || (!href.startsWith('#') && !href.includes('/#'))) return;
      
      // If we're on a subpage and clicking a hash link, we need to navigate to main page
      if (window.location.pathname.includes('/servicios/') && href.includes('/#')) {
        // Let the browser handle the navigation
        return;
      }

      // Check if href contains a hash
      const hashMatch = href.match(/#(.+)$/);
      if (hashMatch) {
        e.preventDefault();
        state.disableIndicatorUpdate = true;

        const targetIdClean = hashMatch[1];
        const targetHref = `#${targetIdClean}`;

        allNavLinks.forEach(item => {
          const itemHref = item.getAttribute('href');
          item.classList.remove('nav-active');
          if (itemHref && itemHref.endsWith(targetHref)) {
            item.classList.add('nav-active');
            state.activeNavItem = item as HTMLElement;
          }
        });

        if (state.activeNavItem) moveIndicatorTo(state.activeNavItem);

        if (targetIdClean === 'hero') {
          smoothScrollTo(0, 2000);
        } else {
          const targetSection = document.getElementById(targetIdClean);
          if (targetSection && state.header) {
            const adjustAttr = link.getAttribute('data-scroll-adjust');
            const customAdjust = adjustAttr ? parseInt(adjustAttr) : 0;
            const headerHeight = state.header.offsetHeight;
            const targetPosition = targetSection.getBoundingClientRect().top + window.pageYOffset - headerHeight - customAdjust;
            smoothScrollTo(targetPosition, 2000);
          }
        }

        setTimeout(() => {
          state.disableIndicatorUpdate = false;
        }, 2000);
      }
    });
  });

  // Logo link
  if (logoLink) {
    logoLink.addEventListener('click', (e) => {
      const logoHref = logoLink.getAttribute('href');
      if (window.location.pathname === logoHref || logoHref === '/') {
        e.preventDefault();
        smoothScrollTo(0, 2000);
      }
    });
  }
  
  // Contact button smooth scrolling
  const contactBtn = document.querySelector('.contact-btn');
  if (contactBtn) {
    contactBtn.addEventListener('click', (e) => {
      const href = contactBtn.getAttribute('href');
      const hashMatch = href?.match(/#(.+)$/);
      
      if (hashMatch) {
        e.preventDefault();
        const targetIdClean = hashMatch[1];
        const targetSection = document.getElementById(targetIdClean);
        
        if (targetSection && state.header) {
          const headerHeight = state.header.offsetHeight;
          const targetPosition = targetSection.getBoundingClientRect().top + window.pageYOffset - headerHeight;
          smoothScrollTo(targetPosition, 2000);
        }
      }
    });
  }
  
  // Dropdown button smooth scrolling (Products, Services)
  document.querySelectorAll('button[data-section]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const sectionId = btn.getAttribute('data-section');
      if (!sectionId) return;
      const targetSection = document.getElementById(sectionId);

      if (targetSection && state.header) {
        e.preventDefault();
        const headerHeight = state.header.offsetHeight;
        const targetPosition = targetSection.getBoundingClientRect().top + window.pageYOffset - headerHeight;
        smoothScrollTo(targetPosition, 2000);

        // Close the dropdown
        state.dropdownTriggers.forEach(trigger => trigger.classList.remove('expanded'));
      }
    });
  });
  
  // Add a nav container mouseleave handler as a fallback
  const mainNav = document.getElementById('main-nav');
  if (mainNav) {
    mainNav.addEventListener('mouseleave', () => {
      if (state.disableIndicatorUpdate) return;
      const returnItem = getReturnNavItem();
      if (returnItem) {
        setTimeout(() => {
          moveIndicatorTo(returnItem);
        }, 50);
      }
    });
  }
}

// Smooth scroll helper
function smoothScrollTo(targetPosition: number, duration: number) {
  const startPosition = window.pageYOffset;
  const distance = targetPosition - startPosition;
  let startTime: number | null = null;
  
  function animation(currentTime: number) {
    if (startTime === null) startTime = currentTime;
    const timeElapsed = currentTime - startTime;
    const progress = Math.min(timeElapsed / duration, 1);
    const ease = easeInOutCubic(progress);
    
    window.scrollTo(0, startPosition + distance * ease);
    
    if (timeElapsed < duration) {
      requestAnimationFrame(animation);
    }
  }
  
  function easeInOutCubic(t: number) {
    return t < 0.5 
      ? 4 * t * t * t 
      : 1 - Math.pow(-2 * t + 2, 3) / 2;
  }
  
  requestAnimationFrame(animation);
}

// Setup mobile menu
function setupMobileMenu() {
  const mobileToggle = document.getElementById('mobile-toggle');
  const burgerIcon = document.querySelector('.burger-icon');

  if (mobileToggle && burgerIcon) {
    state.mobileToggleListener = () => {
      window.dispatchEvent(new CustomEvent('mobile-menu-toggle'));
    };

    state.mobileOpenedListener = () => {
      state.isMenuOpen = true;
      burgerIcon.classList.add('active');
      if (state.header) {
        state.header.style.zIndex = '1100';
        state.header.classList.remove('shadow-lg');
      }
    };

    state.mobileClosedListener = () => {
      state.isMenuOpen = false;
      burgerIcon.classList.remove('active');
      if (state.header) {
        state.header.style.zIndex = '';
        state.header.classList.add('shadow-lg');
      }
    };

    mobileToggle.addEventListener('click', state.mobileToggleListener);
    window.addEventListener('mobile-menu-opened', state.mobileOpenedListener as EventListener);
    window.addEventListener('mobile-menu-closed', state.mobileClosedListener as EventListener);
  }
}

// Setup shared dropdown panel with GSAP animations
function setupDropdowns() {
  import('gsap').then((gsapMod) => {
    const gsap = gsapMod.gsap || gsapMod.default || gsapMod;
    setupDropdownsWithGsap(gsap);
  });
}

function setupDropdownsWithGsap(gsap: any) {
  const panel = state.dropdownPanel;
  if (!panel) return;

  const ease = 'power3.out';
  const cardGroups = new Map<string, { group: HTMLElement; cards: NodeListOf<Element> }>();
  panel.querySelectorAll('.card-group[data-group]').forEach(el => {
    const key = el.getAttribute('data-group')!;
    cardGroups.set(key, { group: el as HTMLElement, cards: el.querySelectorAll('.nav-card') });
  });

  let hideTimer: number | null = null;
  let panelOpen = false;
  let currentTl: any = null;

  // Set initial states
  gsap.set(panel, { height: 0, overflow: 'hidden' });
  cardGroups.forEach(({ cards }) => gsap.set(cards, { yPercent: 120 }));

  // Build a timeline for a specific card group
  function buildTimeline(key: string) {
    const target = cardGroups.get(key);
    if (!target) return null;

    // Activate group
    cardGroups.forEach(({ group }) => group.classList.remove('active'));
    target.group.classList.add('active');
    gsap.set(target.cards, { yPercent: 120 });

    const tl = gsap.timeline({ paused: true });

    // Panel opens first
    tl.to(panel, { height: 'auto', duration: 0.3, ease });

    // Cards slide up from below — no opacity, overflow:hidden clips them naturally
    tl.to(target.cards, { yPercent: 0, duration: 0.4, ease, stagger: 0.08 }, '-=0.05');

    return tl;
  }

  function openPanel(key: string) {
    if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }

    const target = cardGroups.get(key);
    if (!target) return;

    // Update trigger arrows
    state.dropdownTriggers.forEach((trigger, k) => {
      trigger.classList.toggle('expanded', k === key);
    });

    if (!panelOpen) {
      // Panel closed — build timeline and play forward
      panelOpen = true;
      state.activeDropdown = key;
      gsap.set(panel, { height: 0 });

      if (currentTl) currentTl.kill();
      currentTl = buildTimeline(key);
      if (currentTl) currentTl.play(0);

    } else if (state.activeDropdown !== key) {
      // Panel open, switching groups — reverse current, then play new
      const oldTl = currentTl;
      state.activeDropdown = key;

      if (oldTl) {
        oldTl.eventCallback('onReverseComplete', () => {
          // Old cards fully reversed — now build and play new
          gsap.set(panel, { height: 0 });
          currentTl = buildTimeline(key);
          if (currentTl) currentTl.play(0);
        });
        oldTl.reverse();
      } else {
        gsap.set(panel, { height: 0 });
        currentTl = buildTimeline(key);
        if (currentTl) currentTl.play(0);
      }
    }
  }

  function closePanel() {
    state.dropdownTriggers.forEach(trigger => trigger.classList.remove('expanded'));

    if (currentTl) {
      currentTl.eventCallback('onReverseComplete', () => {
        panelOpen = false;
        state.activeDropdown = null;
        cardGroups.forEach(({ group }) => group.classList.remove('active'));
      });
      currentTl.reverse();
    }
  }

  function scheduleClose() {
    if (hideTimer) clearTimeout(hideTimer);
    hideTimer = window.setTimeout(() => {
      let stillHovering = panel?.matches(':hover');
      state.dropdownTriggers.forEach(trigger => {
        if (trigger.matches(':hover')) stillHovering = true;
      });
      if (stillHovering) return;
      closePanel();
      hideTimer = null;
    }, 200);
  }

  function cancelClose() {
    if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
  }

  // Bind events to each trigger
  state.dropdownTriggers.forEach((triggerEl, key) => {
    triggerEl.addEventListener('pointerenter', () => openPanel(key));
    triggerEl.addEventListener('pointerleave', scheduleClose);
    triggerEl.addEventListener('focusin', () => openPanel(key));
    triggerEl.addEventListener('focusout', scheduleClose);
    triggerEl.addEventListener('click', (e) => {
      if (!panelOpen || state.activeDropdown !== key) {
        e.preventDefault();
        openPanel(key);
      } else {
        closePanel();
      }
    }, { capture: true });
  });

  // Bind events to the shared panel
  panel.addEventListener('pointerenter', cancelClose);
  panel.addEventListener('pointerleave', scheduleClose);
  panel.addEventListener('focusin', cancelClose);
  panel.addEventListener('focusout', scheduleClose);
}

// Setup scroll handlers
function setupScrollHandlers() {
  // Resize handler
  state.resizeListener = () => {
    if (state.activeNavItem) moveIndicatorTo(state.activeNavItem);
  };
  window.addEventListener('resize', state.resizeListener);

  // Orientation change
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      if (state.activeNavItem) moveIndicatorTo(state.activeNavItem);
    }, 200);
  });

  // Touch device detection
  const isTouchDevice = () => {
    return 'ontouchstart' in window || ('maxTouchPoints' in navigator && (navigator as any).maxTouchPoints > 0);
  };

  if (isTouchDevice()) {
    document.documentElement.classList.add('touch-device');
  }
}

// Initialize on DOMContentLoaded
document.addEventListener('DOMContentLoaded', initializeHeader);

// Re-initialize on Astro page navigation
document.addEventListener('astro:page-load', initializeHeader);
</script>

<style>
  #main-header {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-weight: 500;
    transform: translateY(-100%);
    opacity: 0;
  }
  
  #main-header.visible {
    transform: translateY(0);
    opacity: 1;
  }
  
  #main-nav {
    position: relative;
  }
  
  #nav-indicator {
    position: absolute;
    bottom: -4px;
    height: 2px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }
  
  .nav-dropdown-arrow {
    transition: transform 0.2s ease;
  }
  
  .nav-dropdown.expanded .nav-dropdown-arrow {
    transform: rotate(180deg);
  }
  
  .nav-expansion {
    height: 0;
    overflow: hidden;
  }

  .nav-expansion .relative {
    display: grid;
  }

  .card-group {
    grid-area: 1 / 1;
    visibility: hidden;
  }

  .card-group.active {
    visibility: visible;
  }

  .nav-card {
    will-change: transform, opacity;
  }
  
  body.menu-open {
    overflow: hidden;
  }
  
  .burger-icon {
    width: 24px;
    height: 20px;
    position: relative;
    transform: rotate(0deg);
    transition: .5s ease-in-out;
    cursor: pointer;
  }
  
  .burger-icon span {
    display: block;
    position: absolute;
    height: 2px;
    width: 100%;
    background: black;
    opacity: 1;
    left: 0;
    transform: rotate(0deg);
    transition: .3s ease-in-out;
  }

  .burger-icon span:nth-child(1) {
    top: 0px;
  }
  
  .burger-icon span:nth-child(2) {
    top: 9px;
  }
  
  .burger-icon span:nth-child(3) {
    top: 18px;
  }
  
  .burger-icon.active span:nth-child(1) {
    top: 9px;
    transform: rotate(135deg);
  }
  
  .burger-icon.active span:nth-child(2) {
    opacity: 0;
    left: -60px;
  }
  
  .burger-icon.active span:nth-child(3) {
    top: 9px;
    transform: rotate(-135deg);
  }
  
  @media (max-width: 768px) {
    #main-header {
      padding: 1rem;
    }
  }

</style>