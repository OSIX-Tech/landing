---
interface Props {
  duration?: number;
}

const { duration = 1000 } = Astro.props;
---

<div id="loading-screen" class="loading-screen" data-duration={duration}>
  <div id="rive-logo-container" class="rive-container"></div>
</div>

<style>
  .loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #ffffff;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    transition: opacity 0.5s ease-out;
  }

  .loading-screen.fade-out {
    opacity: 0;
    pointer-events: none;
  }

  .rive-container {
    width: 200px;
    height: 200px;
  }

  @media (max-width: 768px) {
    .rive-container {
      width: 150px;
      height: 150px;
    }
  }
</style>

<script>
  // Block page animations until loading is complete
  (window as any).isLoadingComplete = false;
  
  document.addEventListener('DOMContentLoaded', async () => {
    const loadingScreen = document.getElementById('loading-screen');
    const container = document.getElementById('rive-logo-container');
    
    if (!loadingScreen || !container) return;

    const duration = parseInt(loadingScreen.getAttribute('data-duration') || '1000');

    // Import Rive dynamically
    const { Rive } = await import('@rive-app/canvas');

    // Ensure the page content is hidden initially
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    const completeLoading = () => {
      // Dispatch event to notify other components
      (window as any).isLoadingComplete = true;
      window.dispatchEvent(new CustomEvent('loadingComplete'));
      
      // Add class to body for CSS animations
      document.body.classList.add('loading-complete');
      
      // Ensure scrolling is restored
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
      document.body.style.removeProperty('overflow');
      document.documentElement.style.removeProperty('overflow');
    };

    // Initialize Rive animation
    const rive = new Rive({
      src: '/animations/logoosix.riv',
      canvas: document.createElement('canvas'),
      autoplay: true,
      stateMachines: 'State Machine 1',
      onLoad: () => {
        // Get the canvas element from the rive instance
        const riveElement = rive as any;
        const canvas = riveElement.canvas || riveElement.renderer?.canvas;
        if (canvas && container) {
          container.appendChild(canvas);
          canvas.style.width = '100%';
          canvas.style.height = '100%';
        }
        
        // Start fade out after specified duration
        setTimeout(() => {
          // Simply add the fade-out class
          loadingScreen.classList.add('fade-out');
          
          // Remove after transition completes
          setTimeout(() => {
            loadingScreen.remove();
            completeLoading();
          }, 500); // Match CSS transition duration
        }, duration);
      },
      onLoadError: (error) => {
        console.error('Rive loading error:', error);
        // If Rive fails to load, still remove the loading screen
        setTimeout(() => {
          loadingScreen.classList.add('fade-out');
          setTimeout(() => {
            loadingScreen.remove();
            completeLoading();
          }, 500);
        }, 100);
      }
    });

    // Fallback: ensure everything is cleaned up after max time
    setTimeout(() => {
      if (loadingScreen && loadingScreen.parentNode) {
        loadingScreen.remove();
      }
      completeLoading();
    }, duration + 1500);
  });
</script>