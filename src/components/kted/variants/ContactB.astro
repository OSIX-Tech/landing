---
interface Props {
  lang?: string;
  variant?: string;
}

const { lang = 'es', variant = 'b' } = Astro.props;
const translations = await import(`../../../../public/locales/${lang}.json`);
const t = (k: string) => translations.default[k] || k;

const sectors = [
  { value: 'salud', label: t('kted.sectors.health') },
  { value: 'agroalimentario', label: t('kted.sectors.agrifood') },
  { value: 'logistica', label: t('kted.sectors.logistics') },
  { value: 'turismo', label: t('kted.sectors.tourism') },
  { value: 'energia', label: t('kted.sectors.energy') },
  { value: 'industria', label: t('kted.sectors.industry') },
  { value: 'construccion', label: t('kted.sectors.construction') },
  { value: 'otro', label: t('kted.contact.form.sector.other') }
];
---

<section id="contact" class="relative py-20 md:py-28 bg-white overflow-hidden" data-variant={variant}>
  <!-- Subtle grid background -->
  <div class="absolute inset-0 opacity-50" style="background-image: linear-gradient(rgba(229, 231, 235, 0.5) 1px, transparent 1px), linear-gradient(to right, rgba(229, 231, 235, 0.5) 1px, transparent 1px); background-size: 60px 60px;"></div>

  <div class="relative z-10 max-w-4xl mx-auto px-6 md:px-12">
    <!-- Header with urgency -->
    <div class="text-center mb-12">
      <div class="inline-flex items-center gap-3 px-6 py-3 bg-black text-white mb-8">
        <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
        <span class="text-sm font-bold tracking-wider uppercase">
          {lang === 'es' ? 'PLAZAS LIMITADAS' : 'LIMITED SPOTS'}
        </span>
        <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
      </div>

      <h2 class="text-4xl md:text-5xl font-bold text-black mb-4">
        {lang === 'es' ? 'ASEGURA TU PLAZA' : 'SECURE YOUR SPOT'}
      </h2>
      <p class="text-gray-500 text-lg max-w-xl mx-auto">
        {lang === 'es'
          ? 'Los fondos se agotan por orden de llegada. No esperes más.'
          : "Funds are allocated on a first-come basis. Don't wait."}
      </p>
    </div>

    <!-- Form card -->
    <div class="border border-gray-200 bg-white p-8 md:p-12">
      <form id="kted-contact-form" class="space-y-6" data-variant={variant}>
        <!-- Row 1: Name & Email -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="kted-name" class="block text-gray-400 text-xs uppercase tracking-wider mb-2">
              {t('kted.contact.form.name')} <span class="text-black">*</span>
            </label>
            <input
              type="text"
              id="kted-name"
              name="user_name"
              class="w-full px-4 py-4 bg-white border border-gray-200 text-black focus:outline-none focus:border-black transition-colors placeholder:text-gray-300"
              required
              minlength="2"
              placeholder="_"
            />
          </div>
          <div>
            <label for="kted-email" class="block text-gray-400 text-xs uppercase tracking-wider mb-2">
              {t('kted.contact.form.email')} <span class="text-black">*</span>
            </label>
            <input
              type="email"
              id="kted-email"
              name="user_email"
              class="w-full px-4 py-4 bg-white border border-gray-200 text-black focus:outline-none focus:border-black transition-colors placeholder:text-gray-300"
              required
              placeholder="_@_"
            />
          </div>
        </div>

        <!-- Row 2: Company & Phone -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="kted-company" class="block text-gray-400 text-xs uppercase tracking-wider mb-2">
              {t('kted.contact.form.company')} <span class="text-black">*</span>
            </label>
            <input
              type="text"
              id="kted-company"
              name="user_company"
              class="w-full px-4 py-4 bg-white border border-gray-200 text-black focus:outline-none focus:border-black transition-colors placeholder:text-gray-300"
              required
              minlength="2"
              placeholder="_"
            />
          </div>
          <div>
            <label for="kted-phone" class="block text-gray-400 text-xs uppercase tracking-wider mb-2">
              {t('kted.contact.form.phone')}
            </label>
            <input
              type="tel"
              id="kted-phone"
              name="user_phone"
              class="w-full px-4 py-4 bg-white border border-gray-200 text-black focus:outline-none focus:border-black transition-colors placeholder:text-gray-300"
              placeholder="+34 ___ ___ ___"
            />
          </div>
        </div>

        <!-- Sector -->
        <div>
          <label for="kted-sector" class="block text-gray-400 text-xs uppercase tracking-wider mb-2">
            {t('kted.contact.form.sector')}
          </label>
          <div class="relative">
            <select
              id="kted-sector"
              name="user_sector"
              class="w-full px-4 py-4 bg-white border border-gray-200 text-black focus:outline-none focus:border-black transition-colors appearance-none cursor-pointer"
            >
              <option value="">{t('kted.contact.form.sector.placeholder')}</option>
              {sectors.map(sector => (
                <option value={sector.value}>{sector.label}</option>
              ))}
            </select>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Hidden message field -->
        <input type="hidden" name="message" value="" />

        <!-- Submit -->
        <button
          type="submit"
          class="submit-btn btn-primary w-full py-5 px-8 text-lg justify-center"
        >
          <span class="btn-text">{lang === 'es' ? 'RESERVAR AHORA' : 'RESERVE NOW'}</span>
          <svg class="w-5 h-5 transition-transform duration-300 group-hover:translate-x-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
          </svg>
        </button>
      </form>

      <div id="kted-form-status" class="hidden mt-4 text-center text-black font-medium text-sm"></div>

      <!-- Trust badges -->
      <div class="mt-8 pt-8 border-t border-gray-200 flex flex-wrap justify-center gap-8">
        <div class="flex items-center gap-2 text-gray-400">
          <svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
          <span class="text-xs uppercase tracking-wider">{lang === 'es' ? 'DATOS SEGUROS' : 'SECURE DATA'}</span>
        </div>
        <div class="flex items-center gap-2 text-gray-400">
          <svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="text-xs uppercase tracking-wider">{lang === 'es' ? 'RESPUESTA 24H' : '24H RESPONSE'}</span>
        </div>
        <div class="flex items-center gap-2 text-gray-400">
          <svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
          </svg>
          <span class="text-xs uppercase tracking-wider">{lang === 'es' ? 'SIN COMPROMISO' : 'NO COMMITMENT'}</span>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { initEmailJS, sendEmail } from '../../../utils/emailjs';
  import { trackFormStart, trackFormSubmit } from '../../../utils/analytics';

  function initializeKTEDContact() {
    initEmailJS();

    const form = document.getElementById('kted-contact-form') as HTMLFormElement | null;
    const statusEl = document.getElementById('kted-form-status');
    const variant = form?.dataset.variant || 'b';
    let formStarted = false;

    if (form) {
      form.addEventListener('focusin', () => {
        if (!formStarted) {
          formStarted = true;
          trackFormStart(variant);
        }
      }, { once: true });

      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;
        if (!submitButton) return;

        const btnText = submitButton.querySelector('.btn-text');
        const originalText = btnText?.textContent || '';
        if (btnText) btnText.textContent = 'PROCESANDO...';
        submitButton.disabled = true;

        const formData = new FormData(form);

        const company = formData.get('user_company') || '';
        const phone = formData.get('user_phone') || '';
        const sector = formData.get('user_sector') || '';

        const fullMessage = `
[SOLICITUD KTED URGENTE - Variante ${variant.toUpperCase()}]

Empresa: ${company}
Teléfono: ${phone}
Sector: ${sector}
        `.trim();

        const date = new Date().toLocaleString('es-ES', {
          day: '2-digit',
          month: 'long',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
        });

        const templateParams = {
          user_name: formData.get('user_name'),
          user_email: formData.get('user_email'),
          message: fullMessage,
          date,
        };

        try {
          await sendEmail(templateParams);
          trackFormSubmit(variant);
          if (btnText) btnText.textContent = '✓ PLAZA RESERVADA';
          form.reset();

          if (statusEl) {
            statusEl.textContent = 'Recibirás confirmación en menos de 24 horas.';
            statusEl.classList.remove('hidden');
          }

          setTimeout(() => {
            if (btnText) btnText.textContent = originalText;
            submitButton.disabled = false;
            if (statusEl) statusEl.classList.add('hidden');
          }, 5000);
        } catch (error) {
          console.error('Error:', error);
          if (btnText) btnText.textContent = 'ERROR';
          setTimeout(() => {
            if (btnText) btnText.textContent = originalText;
            submitButton.disabled = false;
          }, 3000);
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    if ((window as any).isLoadingComplete) {
      initializeKTEDContact();
    } else {
      window.addEventListener('loadingComplete', initializeKTEDContact);
    }
  });
</script>
